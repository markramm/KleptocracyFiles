<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debugging Democracy — Interactive Timeline</title>
  <link rel="stylesheet" href="tailwind.min.css" />
  <style>
    html, body, #root { height: 100%; width: 100%; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
      Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <div id="root" class="w-full"></div>
  <script>
    const e = React.createElement;
    function App() {
      const [events, setEvents] = React.useState([]);
      const [query, setQuery] = React.useState("");
      const [tag, setTag] = React.useState("");
      const [modal, setModal] = React.useState(null);
      const [zoom, setZoom] = React.useState(4);

      React.useEffect(() => {
        if (location.protocol === "file:") {
          console.error("Use a local HTTP server (e.g. 'python -m http.server') to view the timeline.");
        }
        fetch("../timeline/index.json")
          .then((r) => r.json())
          .then((d) => setEvents(d.events || []))
          .catch((err) => console.error("failed to load index", err));
      }, []);

      const tags = React.useMemo(
        () => Array.from(new Set(events.flatMap((ev) => ev.tags || []))).sort(),
        [events]
      );

      const filtered = events.filter((ev) => {
        const evTags = ev.tags || [];
        const matchesTag = !tag || evTags.includes(tag);
        const matchesQuery =
          !query ||
          (ev.title + " " + (ev.summary || "")).toLowerCase().includes(query.toLowerCase());
        return matchesTag && matchesQuery;
      });

      const [startMs, endMs] = React.useMemo(() => {
        if (!events.length) return [0, 1];
        const times = events.map((ev) => new Date(ev.date).getTime());
        return [Math.min(...times), Math.max(...times)];
      }, [events]);

      const range = endMs - startMs || 1;

      function leftPercent(date) {
        return ((new Date(date).getTime() - startMs) / range) * 100;
      }

      function openModal(ev) {
        const file = `../timeline/${ev._file}`;
        fetch(file)
          .then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.text();
          })
          .then((txt) => {
            try {
              jsyaml.load(txt);
              setModal({ title: ev.title, text: txt });
            } catch (err) {
              throw new Error("Invalid YAML");
            }
          })
          .catch((err) => setModal({ title: ev.title, text: String(err) }));
      }

      function closeModal() {
        setModal(null);
      }

      return e("div", { className: "h-screen w-full flex flex-col" }, [
        e("div", { className: "sticky top-0 z-10 bg-neutral-950 p-4 flex flex-wrap items-center gap-2" }, [

          e("input", {
            type: "text",
            placeholder: "Search…",
            className: "border px-2 py-1 rounded text-neutral-900",
            value: query,
            onChange: (ev) => setQuery(ev.target.value),
          }),
          e(
            "select",
            {
              className: "border px-2 py-1 rounded text-neutral-900",
              value: tag,
              onChange: (ev) => setTag(ev.target.value),
            },
            [
              e("option", { value: "" }, "All tags"),
              ...tags.map((t) => e("option", { key: t, value: t }, t)),
            ]
          ),
          e(
            "label",
            { className: "flex items-center gap-2 text-sm" },
            [
              "Zoom",
              e("input", {
                type: "range",
                min: 1,
                max: 10,
                step: 0.5,
                className: "w-40",
                value: zoom,
                onChange: (ev) => setZoom(parseFloat(ev.target.value)),
              }),
            ]
          ),
        ]),
        e(
          "div",
          { className: "flex-1 overflow-x-auto p-4" },
          e(
            "div",
            {
              className: "relative h-full",
              style: { width: `${zoom * 100}%`, minHeight: "40rem" },
            },

            [
              e("div", {
                className: "absolute top-1/2 left-0 right-0 h-px bg-neutral-700",
              }),
              ...filtered.map((ev, idx) => {
                const left = leftPercent(ev.date);
                const lanes = [15, 30, 70, 85];
                const top = lanes[idx % lanes.length];
                const above = top < 50;

                return e(
                  React.Fragment,
                  { key: ev.id },
                  [
                    e("div", {
                      className: "absolute w-px bg-neutral-700",
                      style: {
                        left: `${left}%`,
                        top: `${above ? top : 50}%`,
                        height: `${Math.abs(50 - top)}%`,
                        transform: "translateX(-50%)",
                      },
                    }),
                    e(
                      "button",
                      {
                        className:
                          "absolute w-3 h-3 bg-neutral-100 border border-neutral-700 rounded-full cursor-pointer",
                        style: {
                          left: `${left}%`,
                          top: "50%",
                          transform: "translate(-50%, -50%)",
                        },
                        onClick: () => openModal(ev),
                        title: `${ev.date} – ${ev.title}`,
                      }
                    ),
                    e(
                      "div",
                      {
                        className: "absolute w-64 text-sm text-center",
                        style: {
                          left: `${left}%`,
                          top: `${top}%`,
                          transform: "translate(-50%, -50%)",
                        },
                      },
                      ev.title
                    ),
                  ]
                );
              }),
            ]
          )
        ),
        modal &&
          e(
            "div",
            {
              className:
                "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center",
              onClick: closeModal,
            },
            [
              e(
                "div",
                {
                  className:
                    "bg-neutral-900 p-4 rounded max-w-2xl w-full max-h-full overflow-auto",
                  onClick: (ev) => ev.stopPropagation(),
                },
                [
                  e("div", { className: "font-semibold mb-2" }, modal.title),
                  e(
                    "button",
                    { className: "mb-2 px-2 py-1 border rounded", onClick: closeModal },
                    "Close"
                  ),
                  e("pre", { className: "whitespace-pre-wrap text-sm" }, modal.text),
                ]
              ),
            ]
          ),
      ]);
    }
    const rootEl = document.getElementById("root");
    if (location.protocol === "file:") {
      rootEl.innerHTML = '<p class="p-4">Run a local web server (e.g., <code>python -m http.server</code>) to view the timeline.</p>';
    } else {
      ReactDOM.createRoot(rootEl).render(e(App));
    }
  </script>
</body>
</html>

