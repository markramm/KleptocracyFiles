<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debugging Democracy — Interactive Timeline</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vis-timeline@9.5.2/dist/vis-timeline-graph2d.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue,
 Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
</head>
<body class="bg-neutral-950 text-neutral-100">
<div class="p-4 space-y-4 max-w-5xl mx-auto">
  <div class="flex flex-wrap gap-2">
    <input id="search" class="flex-1 min-w-[12rem] p-2 rounded bg-neutral-800" placeholder="Search…" />
    <select id="tagFilter" class="p-2 rounded bg-neutral-800">
      <option value="">All tags</option>
    </select>
    <select id="actorFilter" class="p-2 rounded bg-neutral-800">
      <option value="">All actors</option>
    </select>
  </div>
  <div id="timeline" class="relative h-96 border border-neutral-700 rounded"></div>
</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center">
  <div class="bg-neutral-900 p-4 rounded max-w-xl w-full max-h-[90vh] overflow-y-auto">
    <button id="modalClose" class="float-right text-neutral-400">&times;</button>
    <h2 id="modalTitle" class="text-xl font-bold mb-2"></h2>
    <div id="modalBody" class="space-y-2 text-sm"></div>
  </div>
</div>

<script>
if (location.protocol === "file:") {
  console.error("Use a local HTTP server (e.g. 'python -m http.server') to view the timeline.");
}

let allEvents = [];
let currentEvents = [];

const searchInput = document.getElementById('search');
const tagSelect = document.getElementById('tagFilter');
const actorSelect = document.getElementById('actorFilter');

function populateFilters(events) {
  const tagSet = new Set();
  const actorSet = new Set();
  events.forEach(ev => {
    (ev.tags || []).forEach(t => tagSet.add(t));
    (ev.actors || []).forEach(a => actorSet.add(a));
  });
  [...tagSet].sort().forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    tagSelect.appendChild(opt);
  });
  [...actorSet].sort().forEach(a => {
    const opt = document.createElement('option');
    opt.value = a;
    opt.textContent = a;
    actorSelect.appendChild(opt);
  });
}

function applyFilters() {
  const q = searchInput.value.toLowerCase();
  const tag = tagSelect.value;
  const actor = actorSelect.value;
  currentEvents = allEvents.filter(ev => {
    return (!tag || ev.tags.includes(tag)) &&
           (!actor || ev.actors.includes(actor)) &&
           (ev.title.toLowerCase().includes(q) || (ev.summary && ev.summary.toLowerCase().includes(q)));
  });
  renderTimeline();
}

function App() {
  const [events, setEvents] = React.useState([]);
  const [query, setQuery] = React.useState("");
  const [tag, setTag] = React.useState("");

  React.useEffect(() => {
    if (location.protocol === "file:") {
      console.error("Use a local HTTP server (e.g. 'python -m http.server') to view the timeline.");
    }
    fetch("../timeline/index.json")
      .then((r) => r.json())
      .then((d) => setEvents(d.events || []))
      .catch((err) => console.error("failed to load index", err));
  }, []);

  const tags = React.useMemo(() => {
    const set = new Set();
    events.forEach((ev) => (ev.tags || []).forEach((t) => set.add(t)));
    return Array.from(set).sort();
  }, [events]);

  const filtered = events.filter((ev) => {
    const q = query.toLowerCase();
    const matchesText =
      (ev.title || "").toLowerCase().includes(q) ||
      (ev.summary || "").toLowerCase().includes(q);
    const matchesTag = !tag || (ev.tags || []).includes(tag);
    return matchesText && matchesTag;
  });
  svg.call(zoom);
}

  const grouped = filtered.reduce((acc, ev) => {
    const year = ev.date.slice(0, 4);
    (acc[year] ||= []).push(ev);
    return acc;
  }, {});
  const years = Object.keys(grouped).sort().reverse();

  return e(
    "div",
    { className: "max-w-4xl mx-auto p-4 space-y-6" },
    e(
      "div",
      { className: "flex flex-col sm:flex-row gap-2" },
      e("input", {
        className: "w-full sm:flex-1 p-2 rounded bg-neutral-800 text-neutral-100",
        placeholder: "Search…",
        value: query,
        onChange: (ev) => setQuery(ev.target.value),
      }),
      e(
        "select",
        {
          className: "w-full sm:w-48 p-2 rounded bg-neutral-800 text-neutral-100",
          value: tag,
          onChange: (ev) => setTag(ev.target.value),
        },
        e("option", { value: "" }, "All tags"),
        tags.map((t) => e("option", { key: t, value: t }, t))
      )
    ),
    years.map((year) =>
      e(
        "div",
        { key: year },
        e("h2", { className: "text-xl font-bold mt-4 mb-2" }, year),
        grouped[year].map((ev) => e(EventItem, { key: ev.id, ev }))
      )
    )
  );

document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('modal').classList.add('hidden');
});

fetch("../timeline/index.json")
  .then(r => r.json())
  .then(data => {
    allEvents = data.events || [];
    populateFilters(allEvents);
    currentEvents = allEvents.slice();
    renderTimeline();
  })
  .catch(err => console.error("failed to load index", err));
</script>
</body>
</html>
